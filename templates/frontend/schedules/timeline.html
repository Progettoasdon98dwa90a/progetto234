{% extends "frontend/base_cms/base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
  <!-- Schedule Header Section -->
  <div class="card bg-base-300 shadow-xl p-4 m-2">
    <div class="card bg-base-200 shadow-md rounded-md mb-3 p-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <h2 class="card-title text-2xl mb-2 sm:mb-0">
          Modifica Orario #
          <span class="badge badge-secondary text-lg">{{ schedule.id }}</span>
        </h2>
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex items-center">
            <span class="font-bold mr-2">Dal:</span>
            <span class="badge badge-info">{{ schedule.start_date }}</span>
          </div>
          <div class="flex items-center">
            <span class="font-bold mr-2">Al:</span>
            <span class="badge badge-info">{{ schedule.end_date }}</span>
          </div>
          <div class="flex items-center">
            <span class="font-bold mr-2">Sede:</span>
            <span class="badge badge-info">{{ schedule.branch.name }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Schedule Table Section -->
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full border-collapse">
        <thead>
          <tr>
            <th rowspan="2" class="bg-base-300 sticky left-0 z-10"></th>
            {% for day in sorted_days %}
              <th class="bg-base-300 text-center" colspan="{{ day_times_map|get_item:day|length }}">
                {{ day }}
              </th>
            {% endfor %}
          </tr>
          <tr>
            {% for day in sorted_days %}
              {% for time_key in day_times_map|get_item:day %}
                <th class="bg-base-200 text-xs text-center {% if forloop.last %}day-separator{% endif %}">
                  {{ time_key|time_display }}
                </th>
              {% endfor %}
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for e in employees %}
            <tr>
              <td class="sticky left-0 bg-base-300 z-10 font-semibold">
                {{ e.name }}
              </td>
              {% for day in sorted_days %}
                {% for time_key in day_times_map|get_item:day %}
                  {% with assigned_list=schedule_data|get_item:day|get_item:time_key %}
                    <td class="text-center hover:bg-base-100 hover:cursor-pointer border border-base-200 {% if forloop.last %}day-separator{% endif %} {% if e.id|stringformat:'s' in assigned_list %}assignedCell{% endif %}"
                        data-day="{{ day }}"
                        data-time="{{ time_key }}"
                        data-employee-id="{{ e.id }}">
                      {% if e.id|stringformat:"s" in assigned_list %}X{% else %}&nbsp;{% endif %}
                    </td>
                  {% endwith %}
                {% endfor %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Total Hours Display Section -->
  <div class="card bg-base-300 shadow-xl p-4 m-2">
    <div id="workedHoursTotal" class="my-6"></div>
  </div>

  <!-- Inline Styles -->
  <style>
    .assignedCell {
      background-color: rgb(251 191 36 / 0.2); /* Tailwind amber-300, ~20% alpha */
      position: relative;
    }
    .day-separator {
      border-right: 2px solid #000; /* Visual separation between days */
    }
    table {
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid rgba(0, 0, 0, 0.1); /* Subtle borders */
      padding: 0.25rem 0.5rem; /* Reduced padding for compact layout */
    }
    .sticky {
      position: sticky;
      left: 0;
      z-index: 10;
    }
  </style>

  <!-- Enhanced JavaScript -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Employee name mapping for total hours display
      const employeeNameMap = {
        {% for e in employees %}
          "{{ e.id }}": "{{ e.name|escapejs }}",
        {% endfor %}
      };
      const scheduleId = "{{ schedule.id }}";
      const table = document.querySelector("table");
      let isDragging = false;
      const cellMap = new Map();

      // Start dragging and toggle initial cell
      table.addEventListener("mousedown", (e) => {
        const cell = e.target.closest("td[data-day]");
        if (!cell) return;
        isDragging = true;
        cellMap.clear();
        toggleCell(cell);
        e.preventDefault(); // Prevent text selection
      });

      // Toggle cells during drag
      table.addEventListener("mouseover", (e) => {
        if (!isDragging) return;
        const cell = e.target.closest("td[data-day]");
        if (!cell || cellMap.has(cell)) return;
        toggleCell(cell);
      });

      // End dragging and send bulk update
      document.addEventListener("mouseup", async () => {
        if (!isDragging) return;
        isDragging = false;

        const togglesPayload = Array.from(cellMap.entries()).map(([cell, info]) => ({
          day: info.day,
          time_str: info.timeStr,
          employee_id: parseInt(info.employeeId),
          assign: info.finalAssigned,
        }));

        if (togglesPayload.length === 0) return;

        try {
          const response = await fetch("{% url 'toggle_assignment_bulk' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ schedule_id: scheduleId, toggles: togglesPayload }),
          });
          const data = await response.json();
          if (!data.success) {
            console.warn("Bulk toggle failed:", data.message);
            alert(`Failed to update assignments: ${data.message}`);
          }
          updateTotalHours();
        } catch (err) {
          console.error("Bulk toggle error:", err);
          alert("An error occurred while updating assignments.");
        }
      });

      // Toggle cell state
      function toggleCell(cell) {
        const day = cell.dataset.day;
        const timeStr = cell.dataset.time.trim();
        const employeeId = cell.dataset.employeeId;
        const currentlyAssigned = cell.innerText.trim() === "X";
        const newAssigned = !currentlyAssigned;

        cell.innerText = newAssigned ? "X" : "\u00A0"; // Non-breaking space
        cell.classList.toggle("assignedCell", newAssigned);
        cellMap.set(cell, { day, timeStr, employeeId, finalAssigned: newAssigned });
      }

      // Get CSRF token for secure POST requests
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        return parts.length === 2 ? parts.pop().split(";").shift() : null;
      }

      // Calculate and display total hours
      function updateTotalHours() {
        const assignedCells = document.querySelectorAll("td.assignedCell");
        const employeeHoursMap = {};

        assignedCells.forEach((cell) => {
          const empId = cell.dataset.employeeId;
          const timeStr = cell.dataset.time.trim();
          let hours = timeStr.includes("-") ? getHoursFromRange(timeStr) : 0.5;
          employeeHoursMap[empId] = (employeeHoursMap[empId] || 0) + hours;
        });

        renderTotalWorkedHours(employeeHoursMap);
      }

      // Calculate hours from time range (e.g., "09:00-10:00")
      function getHoursFromRange(rangeStr) {
        const [start, end] = rangeStr.split("-").map((s) => s.trim());
        const startHrs = parseTimeToDecimal(start);
        const endHrs = parseTimeToDecimal(end);
        return endHrs > startHrs ? endHrs - startHrs : 0;
      }

      // Parse time string to decimal (e.g., "09:00" -> 9.0)
      function parseTimeToDecimal(time) {
        const [hours, minutes] = time.split(":").map(Number);
        return hours + (minutes || 0) / 60;
      }

      // Render total hours table
      function renderTotalWorkedHours(hoursMap) {
        const tbody = Object.entries(hoursMap)
          .sort(([a], [b]) => a - b)
          .map(([empId, hours]) => `
            <tr>
              <td><div class="badge badge-primary">${employeeNameMap[empId] || `ID#${empId}`}</div></td>
              <td><div class="badge badge-primary">${hours.toFixed(2)}</div></td>
            </tr>
          `).join("") || `<tr><td colspan="2">No assigned cells</td></tr>`;

        document.getElementById("workedHoursTotal").innerHTML = `
          <div class="mx-auto my-6">
            <table class="table table-zebra table-auto">
              <thead>
                <tr><th>Dipendente</th><th>Ore Totali</th></tr>
              </thead>
              <tbody>${tbody}</tbody>
            </table>
          </div>
        `;
      }

      // Initialize total hours on page load
      updateTotalHours();
    });
  </script>
{% endblock content %}